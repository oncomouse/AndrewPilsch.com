- method = "head.js" # "modernizr"
<!--[if (gte IE 6)&(lte IE 8)]>
= javascript_include_tag("#{javascript_path("vendor/selectivizr/selectivizr.min.js")}")
= javascript_include_tag("//cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.js")
<![endif]-->
/ Fix IE HTML 5 Elements:
<!--[if lt IE 9]>
= javascript_include_tag("//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js")
<![endif]-->
- if method == "head.js"
	= javascript_include_tag("vendor/head/head.min.js")
	:javascript

		// Queue up the location of all the javascript libraries we will be loading. These file
		// paths are generated by Middleman at the moment of site compilation:
		var jquery_js = "//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js",
		    jquery_isotope_js = "#{javascript_path("vendor/jquery/plugins/jquery.isotope.min.js")}",
		    jquery_hashchange_js = "#{javascript_path 'vendor/jquery/plugins/jquery.hashchange.min.js'}",
		    imagesloaded_js = "#{javascript_path("vendor/imagesloaded/imagesloaded.min.js")}",
		    matchmedia_js = "#{javascript_path("vendor/matchMedia/matchmedia.min.js")}",

		    plugins_js = "#{javascript_path("plugins.js")}",
		    mobile_js = "#{javascript_path("mobile.js")}",
		    site_js = "#{javascript_path("site.js")}";
	
		// We put these libraries into an array in order to dynamically add polyfills based on 
		// some tests below (this is because head.js doesn't run a callback if you pass it
		// an empty array for success or failure):
		var head_js_array = [imagesloaded_js, jquery_js, jquery_isotope_js, plugins_js];
		
		// Polyfill for missing matchMedia() method:
		if(!window.matchMedia) {
			head_js_array.push(matchmedia_js);
		}
		
		head.load(head_js_array, function(){
			// Test for mobile version using the Goldilocks media query (see above):
			head.test(
				window.matchMedia("all and (min-width: 33.236em)").matches,
				[jquery_hashchange_js, {isotope: site_js}],
				[{isotope: mobile_js}],
				function() {
					start_isotope();
				}
			);
		});

- elsif method == "modernizr"
	= javascript_include_tag("vendor/modernizr/modernizr-2.6.2.min.js")

	/ Local javascript files:
	= #javascript_include_tag("plugins.js")
	:javascript
		function basename(path) {
		    return path.replace(/\\/g,'/').replace( /.*\//, '' );
		}
		Modernizr.load([
			// First, we load jQuery from Google CDN and jQuery Isotope from local sources:
			{
				load: [
					'//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js',
					'#{javascript_path 'vendor/jquery/plugins/jquery.isotope.min.js'}'
				],
				callback: function (url, result, key) {
					url = basename(url);
					if(url == "jquery.min.js" && !window.jQuery) {
						yepnope('#{javascript_path 'vendor/jquery/jquery.min.js'}');
					}
				}
			},
			// Then, we test for the mobile or full version of the site, using the same
			// media query for the CSS files, above:
			{
				test: Modernizr.mq("all and (min-width: 33.236em)"),
				yep: [
					// We only need hashchange on the full site:
					'#{javascript_path 'vendor/jquery/plugins/jquery.hashchange.min.js'}',
					'#{javascript_path 'site.js'}'
				],
				nope: [
					'#{javascript_path 'mobile.js'}'
				],
				callback: function (url, result, key) {
					url = basename(url);
					if(url == "site.js") {
						start_isotope();
					} else if (url == "mobile.js") {
						start_mobile_isotope();
					}
				}
			}
		]);